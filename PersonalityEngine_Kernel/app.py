"""
PEK Lite – FastAPI Application Entry Point
Stable ASGI app for Railway deployment
"""

from fastapi import FastAPI, HTTPException
from fastapi.responses import HTMLResponse, JSONResponse
from pydantic import BaseModel
from typing import List, Optional

from PersonalityEngine_Kernel.engines.inference.inference_engine import run_inference


# -----------------------------
# FASTAPI APP
# -----------------------------
app = FastAPI(
    title="PEK Lite",
    version="1.0.0"
)


# -----------------------------
# REQUEST MODEL
# -----------------------------
class InferenceRequest(BaseModel):
    responses: List[str]
    context_flags: Optional[dict] = None
    forced_overrides: Optional[dict] = None


# -----------------------------
# HEALTH CHECK
# -----------------------------
@app.get("/health")
def health():
    return {"status": "ok", "engine": "PEK Lite"}


# -----------------------------
# INPUT NORMALIZATION
# -----------------------------
def build_engine_input(payload: InferenceRequest) -> dict:
    return {
        "example_statement": " ".join(payload.responses),
        "context_flags": payload.context_flags or {},
        "forced_overrides": payload.forced_overrides or {}
    }


# -----------------------------
# JSON INFERENCE ENDPOINT
# -----------------------------
@app.post("/infer")
def infer(payload: InferenceRequest):
    if not payload.responses:
        raise HTTPException(status_code=400, detail="No responses provided")

    result = run_inference(build_engine_input(payload))
    return JSONResponse(content=result)


# -----------------------------
# DARK WEB REPORT (EXISTING)
# -----------------------------
@app.post("/report", response_class=HTMLResponse)
def render_report(payload: InferenceRequest):
    if not payload.responses:
        raise HTTPException(status_code=400, detail="No responses provided")

    result = run_inference(build_engine_input(payload))
    lt = result["lite_translation"]

    html = f"""
    <html>
    <head>
        <meta charset="utf-8">
        <title>Personality Engine Kernel — Lite</title>
        <style>
            body {{
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                background: #0e0e11;
                color: #eaeaf0;
                padding: 60px 20px;
            }}
            .container {{
                max-width: 900px;
                margin: auto;
                background: #16161c;
                padding: 52px;
                border-radius: 14px;
            }}
            h1 {{ font-size: 2.3em; }}
            .sub {{ color: #9aa0b0; margin-bottom: 36px; }}
            h2 {{ margin-top: 42px; border-bottom: 1px solid #2a2a35; }}
            p, ul {{ line-height: 1.7; }}
            .footer {{ margin-top: 48px; color: #777; font-size: 0.85em; }}
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Personality Engine Kernel — Lite</h1>
            <div class="sub">Behavioral & cognitive pattern snapshot</div>

            <h2>Orientation Snapshot</h2>
            <p>{lt["orientation_snapshot"]}</p>

            <h2>Underlying Behavioral Patterns</h2>
            <p>Your responses indicate internally driven regulation and self-calibrated processing.</p>

            <h2>Internal Dynamics & Pressure Flow</h2>
            <p>Pressure and cognitive load are absorbed internally before outward expression.</p>

            <h2>Decision & Control Style</h2>
            <p>Decisions are deliberate, internally anchored, and stability-oriented.</p>

            <h2>Real-World Signals</h2>
            <ul>{''.join(f"<li>{s}</li>" for s in lt["real_world_signals"])}</ul>

            <h2>Strengths</h2>
            <ul>{''.join(f"<li>{s}</li>" for s in lt["strengths"])}</ul>

            <h2>Common Misinterpretations</h2>
            <ul>{''.join(f"<li>{s}</li>" for s in lt["common_misinterpretations"])}</ul>

            <h2>Reflection Prompts</h2>
            <ul>{''.join(f"<li>{s}</li>" for s in lt["reflection_prompts"])}</ul>

            <div class="footer">
                Generated by PEK Lite · Insightful Snapshot
            </div>
        </div>
    </body>
    </html>
    """
    return HTMLResponse(content=html)


# -----------------------------
# PDF-SAFE LIGHT REPORT (NEW)
# -----------------------------
@app.post("/report/pdf", response_class=HTMLResponse)
def render_pdf_report(payload: InferenceRequest):
    if not payload.responses:
        raise HTTPException(status_code=400, detail="No responses provided")

    result = run_inference(build_engine_input(payload))
    lt = result["lite_translation"]

    html = f"""
    <html>
    <head>
        <meta charset="utf-8">
        <title>PEK Lite Report</title>
        <style>
            body {{
                font-family: Georgia, "Times New Roman", serif;
                background: #ffffff;
                color: #111;
                padding: 72px;
            }}
            h1 {{ font-size: 28px; margin-bottom: 6px; }}
            .sub {{ color: #555; margin-bottom: 40px; }}
            h2 {{ margin-top: 36px; font-size: 18px; }}
            p, ul {{ line-height: 1.65; font-size: 15px; }}
            .footer {{
                margin-top: 60px;
                font-size: 12px;
                color: #777;
                text-align: center;
            }}
        </style>
    </head>
    <body>
        <h1>Personality Engine Kernel — Lite</h1>
        <div class="sub">Behavioral & cognitive pattern snapshot</div>

        <h2>Orientation Snapshot</h2>
        <p>{lt["orientation_snapshot"]}</p>

        <h2>Underlying Behavioral Patterns</h2>
        <p>Your responses indicate internally driven regulation and deliberate self-calibration.</p>

        <h2>Internal Dynamics & Pressure Flow</h2>
        <p>Pressure is absorbed internally, preserving outward composure while increasing unseen load.</p>

        <h2>Decision & Control Style</h2>
        <p>Decisions favor internal clarity, stability, and forethought over reactive adjustment.</p>

        <h2>Real-World Signals</h2>
        <ul>{''.join(f"<li>{s}</li>" for s in lt["real_world_signals"])}</ul>

        <h2>Strengths</h2>
        <ul>{''.join(f"<li>{s}</li>" for s in lt["strengths"])}</ul>

        <h2>Common Misinterpretations</h2>
        <ul>{''.join(f"<li>{s}</li>" for s in lt["common_misinterpretations"])}</ul>

        <h2>Reflection Prompts</h2>
        <ul>{''.join(f"<li>{s}</li>" for s in lt["reflection_prompts"])}</ul>

        <div class="footer">
            Personality Engine Kernel · PEK Lite Snapshot
        </div>
    </body>
    </html>
    """
    return HTMLResponse(content=html)
