"""
PEK Lite – FastAPI Application Entry Point
Thin HTTP wrapper around the Personality Engine Kernel.
"""

from fastapi import FastAPI, HTTPException
from fastapi.responses import HTMLResponse, JSONResponse
from pydantic import BaseModel
from typing import List, Optional, Dict

from PersonalityEngine_Kernel.engines.inference.inference_engine import run_inference


app = FastAPI(
    title="PEK Lite",
    version="0.4"
)


class InferenceRequest(BaseModel):
    responses: List[str]
    context_flags: Optional[Dict] = None
    forced_overrides: Optional[Dict] = None


@app.get("/health")
def health():
    return {"status": "ok", "engine": "PEK Lite"}


def build_engine_input(payload: InferenceRequest) -> dict:
    return {
        "responses": payload.responses,
        "context_flags": payload.context_flags or {},
        "forced_overrides": payload.forced_overrides or {}
    }


@app.post("/infer")
def infer(payload: InferenceRequest):
    if not payload.responses:
        raise HTTPException(status_code=400, detail="No responses provided")

    result = run_inference(**build_engine_input(payload))
    return JSONResponse(result)


@app.post("/report", response_class=HTMLResponse)
def report(payload: InferenceRequest):
    if not payload.responses:
        raise HTTPException(status_code=400, detail="No responses provided")

    result = run_inference(**build_engine_input(payload))
    lite = result.get("lite_translation", {})

    def render_list(items):
        if not items:
            return ""
        return "<ul>" + "".join(f"<li>{i}</li>" for i in items) + "</ul>"

    html = f"""
    <!DOCTYPE html>
    <html>
    <head>
        <title>PEK Lite — Personality Snapshot</title>
        <style>
            body {{
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: #0e0e11;
                color: #eaeaf0;
                padding: 60px 20px;
            }}
            .container {{
                max-width: 820px;
                margin: auto;
                background: #16161c;
                padding: 50px;
                border-radius: 14px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            }}
            h1 {{ margin-bottom: 8px; }}
            .sub {{ color: #9a9ab0; margin-bottom: 40px; }}
            h2 {{
                margin-top: 40px;
                font-size: 1.35em;
                border-bottom: 1px solid #2a2a35;
                padding-bottom: 10px;
            }}
            ul {{ line-height: 1.7; padding-left: 20px; }}
            li {{ margin-bottom: 8px; }}
            .footer {{
                margin-top: 50px;
                font-size: 0.85em;
                color: #777;
                text-align: center;
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Personality Engine Kernel — Lite</h1>
            <div class="sub">Behavioral & cognitive pattern snapshot</div>

            <h2>Orientation Snapshot</h2>
            <p>{lite.get("orientation_snapshot", "")}</p>

            {f"<h2>Real-World Signals</h2>{render_list(lite.get('real_world_signals', []))}" if lite.get("real_world_signals") else ""}

            {f"<h2>Strengths</h2>{render_list(lite.get('strengths', []))}" if lite.get("strengths") else ""}

            {f"<h2>Common Misinterpretations</h2>{render_list(lite.get('common_misinterpretations', []))}" if lite.get("common_misinterpretations") else ""}

            {f"<h2>Reflection Prompts</h2>{render_list(lite.get('reflection_prompts', []))}" if lite.get("reflection_prompts") else ""}

            <div class="footer">
                Generated by PEK Lite · Full PEK available soon
            </div>
        </div>
    </body>
    </html>
    """

    return html
