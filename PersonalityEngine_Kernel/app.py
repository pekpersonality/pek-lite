"""
PEK Lite – FastAPI Application Entry Point
Stable Lite report renderer (Option 1)
"""

from fastapi import FastAPI, HTTPException
from fastapi.responses import HTMLResponse
from pydantic import BaseModel

from PersonalityEngine_Kernel.engines.inference.inference_engine import run_inference


app = FastAPI(
    title="PEK Lite",
    version="0.5"
)


class InferenceRequest(BaseModel):
    responses: list[str]
    context_flags: dict | None = None
    forced_overrides: dict | None = None


@app.get("/health")
def health():
    return {"status": "ok", "engine": "PEK Lite"}


def render_lite_html(lite: dict) -> str:
    def bullets(items):
        return "".join(f"<li>{i}</li>" for i in items)

    snapshot = lite.get(
        "orientation_snapshot",
        "Your responses suggest an internally consistent motivational structure."
    )

    return f"""
    <!DOCTYPE html>
    <html>
    <head>
        <title>PEK Lite — Personality Snapshot</title>
        <style>
            body {{
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: #0e0e11;
                color: #eaeaf0;
                padding: 50px 20px;
            }}
            .container {{
                max-width: 820px;
                margin: auto;
                background: #16161c;
                padding: 45px;
                border-radius: 14px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.55);
            }}
            h1 {{
                margin-bottom: 6px;
                font-size: 2.2em;
            }}
            .sub {{
                color: #9a9ab0;
                margin-bottom: 36px;
            }}
            h2 {{
                margin-top: 38px;
                font-size: 1.35em;
                border-bottom: 1px solid #2a2a35;
                padding-bottom: 8px;
            }}
            ul {{
                line-height: 1.7;
                padding-left: 20px;
            }}
            li {{
                margin-bottom: 8px;
            }}
            .footer {{
                margin-top: 46px;
                font-size: 0.85em;
                color: #777;
                text-align: center;
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Personality Engine Kernel — Lite</h1>
            <div class="sub">Behavioral & cognitive pattern snapshot</div>

            <h2>Orientation Snapshot</h2>
            <p>{snapshot}</p>

            <h2>Real-World Signals</h2>
            <ul>{bullets(lite.get("real_world_signals", []))}</ul>

            <h2>Strengths</h2>
            <ul>{bullets(lite.get("strengths", []))}</ul>

            <h2>Common Misinterpretations</h2>
            <ul>{bullets(lite.get("common_misinterpretations", []))}</ul>

            <h2>Reflection Prompts</h2>
            <ul>{bullets(lite.get("reflection_prompts", []))}</ul>

            <div class="footer">
                Generated by PEK Lite · Full PEK available soon
            </div>
        </div>
    </body>
    </html>
    """


@app.post("/infer")
def infer(payload: InferenceRequest):
    if not payload.responses:
        raise HTTPException(status_code=400, detail="No responses provided")

    return run_inference(
        responses=payload.responses,
        context_flags=payload.context_flags or {},
        forced_overrides=payload.forced_overrides or {}
    )


@app.post("/report", response_class=HTMLResponse)
def report(payload: InferenceRequest):
    if not payload.responses:
        raise HTTPException(status_code=400, detail="No responses provided")

    result = run_inference(
        responses=payload.responses,
        context_flags=payload.context_flags or {},
        forced_overrides=payload.forced_overrides or {}
    )

    lite = result.get("lite_translation", {})
    return render_lite_html(lite)
